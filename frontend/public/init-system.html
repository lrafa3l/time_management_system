<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGH | Inicializa√ß√£o do Sistema</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Data Initializer -->
    <script src="/src/js/data-initializer.js"></script>
    
    <style>
        :root {
            --charcoal: #29465c;
            --berkeley-blue: #1c3a5c;
            --picton-blue: #23aae2;
            --cerulean: #20708a;
            --alice-blue: #e4eff4;
            --seasalt: #f6f6f6;
        }
        
        body {
            font-family: 'AfacadFlux', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--alice-blue), var(--seasalt));
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--picton-blue);
        }
        
        .header h1 {
            color: var(--charcoal);
            margin: 0;
        }
        
        .header p {
            color: var(--berkeley-blue);
            margin: 10px 0;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .warning-box h3 {
            color: #856404;
            margin-top: 0;
        }
        
        .info-box {
            background: var(--alice-blue);
            border: 1px solid var(--picton-blue);
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .btn-primary {
            background: var(--picton-blue);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background 0.3s;
        }
        
        .btn-primary:hover {
            background: var(--cerulean);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background 0.3s;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .progress-container {
            display: none;
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--picton-blue), var(--cerulean));
            width: 0%;
            transition: width 0.3s;
        }
        
        .log-container {
            display: none;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-success {
            background: #d4edda;
            color: #155724;
        }
        
        .log-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .log-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .credentials-box {
            display: none;
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .credentials-box h3 {
            color: #155724;
            margin-top: 0;
        }
        
        .credential-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Inicializa√ß√£o do Sistema SGH</h1>
            <p>Instituto Polit√©cnico Industrial do Kilamba Kiaxi N¬∫ 8056 "Nova Vida"</p>
            <p><em>"Um diferencial para a sua forma√ß√£o"</em></p>
        </div>

        <div class="warning-box">
            <h3>‚ö†Ô∏è Aten√ß√£o!</h3>
            <p>Esta opera√ß√£o ir√° inicializar o sistema com dados b√°sicos. Execute apenas uma vez ou se desejar reiniciar completamente o sistema.</p>
            <p><strong>Esta a√ß√£o ir√°:</strong></p>
            <ul>
                <li>Criar todas as coordena√ß√µes e disciplinas</li>
                <li>Gerar todas as turmas do sistema</li>
                <li>Cadastrar todas as salas e laborat√≥rios</li>
                <li>Criar usu√°rios e professores iniciais</li>
                <li>Configurar defini√ß√µes do sistema</li>
            </ul>
        </div>

        <div class="info-box">
            <h3>‚ÑπÔ∏è Dados que ser√£o criados:</h3>
            <ul>
                <li><strong>7 Coordena√ß√µes:</strong> EIE, TM, FC, GSI, OCC, DP, INF</li>
                <li><strong>84 Turmas:</strong> 10¬™, 11¬™ e 12¬™ classes para cada coordena√ß√£o</li>
                <li><strong>30 Salas:</strong> 23 salas normais + 7 laborat√≥rios/oficinas</li>
                <li><strong>10 Usu√°rios:</strong> 7 coordenadores + 1 diretor + 1 subdiretor + 1 admin</li>
                <li><strong>M√∫ltiplas Disciplinas:</strong> Todas as disciplinas por coordena√ß√£o</li>
            </ul>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="btn-primary" onclick="startInitialization()">
                üöÄ Inicializar Sistema
            </button>
            <button class="btn-danger" onclick="resetSystem()">
                üîÑ Resetar Sistema Completo
            </button>
        </div>

        <div class="progress-container" id="progressContainer">
            <h3>Progresso da Inicializa√ß√£o</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Preparando...</p>
        </div>

        <div class="log-container" id="logContainer">
            <h3>Log de Execu√ß√£o</h3>
            <div id="logContent"></div>
        </div>

        <div class="credentials-box" id="credentialsBox">
            <h3>üîë Credenciais de Acesso</h3>
            <p>Guarde estas informa√ß√µes com seguran√ßa:</p>
            <div id="credentialsList"></div>
            <p><strong>Senha padr√£o para todos os usu√°rios:</strong> <code>senha123</code></p>
            <p><em>IMPORTANTE: Altere as senhas no primeiro login!</em></p>
        </div>
    </div>

    <script>
        let isInitializing = false;

        async function startInitialization() {
            if (isInitializing) return;
            
            const result = await Swal.fire({
                title: 'Confirmar Inicializa√ß√£o',
                text: 'Tem certeza que deseja inicializar o sistema? Esta opera√ß√£o pode demorar alguns minutos.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sim, inicializar',
                cancelButtonText: 'Cancelar'
            });

            if (!result.isConfirmed) return;

            isInitializing = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('logContainer').style.display = 'block';
            
            try {
                await runInitialization();
                showSuccessMessage();
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                addLog('Erro na inicializa√ß√£o: ' + error.message, 'error');
                Swal.fire('Erro!', 'Falha na inicializa√ß√£o do sistema: ' + error.message, 'error');
            } finally {
                isInitializing = false;
            }
        }

        async function runInitialization() {
            const steps = [
                { name: 'Inicializando Firebase', func: () => dataInitializer.initFirebase() },
                { name: 'Criando disciplinas', func: () => dataInitializer.createDisciplinas() },
                { name: 'Criando coordena√ß√µes', func: () => dataInitializer.createCoordenacoes() },
                { name: 'Criando salas', func: () => dataInitializer.createSalas() },
                { name: 'Criando turmas', func: () => dataInitializer.createTurmas() },
                { name: 'Criando professores e usu√°rios', func: () => dataInitializer.createProfessoresAndUsers() },
                { name: 'Configurando sistema', func: () => dataInitializer.createSystemSettings() }
            ];

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                updateProgress((i / steps.length) * 100, step.name);
                addLog(`Executando: ${step.name}`, 'info');
                
                try {
                    await step.func();
                    addLog(`‚úÖ Conclu√≠do: ${step.name}`, 'success');
                } catch (error) {
                    addLog(`‚ùå Erro em ${step.name}: ${error.message}`, 'error');
                    throw error;
                }
            }

            updateProgress(100, 'Inicializa√ß√£o conclu√≠da!');
        }

        async function resetSystem() {
            const result = await Swal.fire({
                title: '‚ö†Ô∏è ATEN√á√ÉO: Reset Completo',
                html: `
                    <p>Esta opera√ß√£o ir√° <strong>DELETAR TODOS OS DADOS</strong> do sistema:</p>
                    <ul style="text-align: left; margin: 20px;">
                        <li>Todos os usu√°rios (exceto admin atual)</li>
                        <li>Todos os professores</li>
                        <li>Todos os hor√°rios</li>
                        <li>Todas as turmas, salas e disciplinas</li>
                        <li>Todas as configura√ß√µes</li>
                    </ul>
                    <p><strong>Esta a√ß√£o √© IRREVERS√çVEL!</strong></p>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, resetar tudo',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545'
            });

            if (!result.isConfirmed) return;

            // Confirma√ß√£o dupla
            const secondConfirmation = await Swal.fire({
                title: 'Confirma√ß√£o Final',
                text: 'Digite "RESETAR" para confirmar o reset completo:',
                input: 'text',
                inputPlaceholder: 'Digite RESETAR',
                showCancelButton: true,
                confirmButtonText: 'Confirmar Reset',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545',
                preConfirm: (value) => {
                    if (value !== 'RESETAR') {
                        Swal.showValidationMessage('Digite exatamente "RESETAR" para confirmar');
                        return false;
                    }
                    return true;
                }
            });

            if (!secondConfirmation.isConfirmed) return;

            try {
                await performSystemReset();
                Swal.fire('Reset Conclu√≠do!', 'Sistema resetado com sucesso. Execute a inicializa√ß√£o para recriar os dados.', 'success');
            } catch (error) {
                console.error('Erro no reset:', error);
                Swal.fire('Erro!', 'Falha no reset do sistema: ' + error.message, 'error');
            }
        }

        async function performSystemReset() {
            addLog('Iniciando reset do sistema...', 'info');
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('logContainer').style.display = 'block';

            await dataInitializer.initFirebase();
            const db = dataInitializer.db;

            const collections = ['horarios', 'professores', 'users', 'turmas', 'salas', 'disciplinas', 'coordenacoes', 'configuracoes', 'notificacoes'];
            
            for (let i = 0; i < collections.length; i++) {
                const collection = collections[i];
                updateProgress((i / collections.length) * 100, `Deletando ${collection}...`);
                addLog(`Deletando cole√ß√£o: ${collection}`, 'info');
                
                const snapshot = await db.collection(collection).get();
                const batch = db.batch();
                
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                if (!snapshot.empty) {
                    await batch.commit();
                }
                
                addLog(`‚úÖ Cole√ß√£o ${collection} deletada (${snapshot.size} documentos)`, 'success');
            }

            updateProgress(100, 'Reset conclu√≠do!');
            addLog('Reset do sistema conclu√≠do com sucesso!', 'success');
        }

        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
        }

        function addLog(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function showSuccessMessage() {
            document.getElementById('credentialsBox').style.display = 'block';
            
            const credentialsList = document.getElementById('credentialsList');
            const credentials = [
                { role: 'Administrador', email: 'admin@ipikk.edu.ao', name: 'Administrador do Sistema' },
                { role: 'Director', email: 'director@ipikk.edu.ao', name: 'Ferreira Manuel Fragoso' },
                { role: 'Subdirector', email: 'subdirector@ipikk.edu.ao', name: 'Carlos Alberto Brito Teixeira da Silva' },
                { role: 'Coord. EIE', email: 'ezequiel.mazezela@ipikk.edu.ao', name: 'Ezequiel Mazezela' },
                { role: 'Coord. TM', email: 'silsom.bravo@ipikk.edu.ao', name: 'Silsom Bravo' },
                { role: 'Coord. FC', email: 'gilberto.oleque@ipikk.edu.ao', name: 'Gilberto Oleque' },
                { role: 'Coord. GSI', email: 'paulo.dala@ipikk.edu.ao', name: 'Paulo Dala' },
                { role: 'Coord. OCC', email: 'lucas.fragoso@ipikk.edu.ao', name: 'Lucas Fragoso' },
                { role: 'Coord. DP', email: 'muto.kalembe@ipikk.edu.ao', name: 'Muto Kalembe' },
                { role: 'Coord. INF', email: 'diassilua.paulo@ipikk.edu.ao', name: 'Diassilua Paulo' }
            ];

            credentialsList.innerHTML = credentials.map(cred => `
                <div class="credential-item">
                    <strong>${cred.role}:</strong> ${cred.name}<br>
                    <strong>Email:</strong> ${cred.email}
                </div>
            `).join('');

            Swal.fire({
                title: 'üéâ Inicializa√ß√£o Conclu√≠da!',
                html: `
                    <p>O sistema foi inicializado com sucesso!</p>
                    <p>Todos os dados b√°sicos foram criados.</p>
                    <p>Verifique as credenciais de acesso abaixo e fa√ßa login com uma das contas criadas.</p>
                `,
                icon: 'success',
                confirmButtonText: 'Entendi'
            });
        }

        // Verificar se o usu√°rio tem permiss√£o para acessar esta p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Esta p√°gina deve ser acess√≠vel apenas durante a configura√ß√£o inicial
            // ou por administradores
            console.log('P√°gina de inicializa√ß√£o carregada');
            addLog('Sistema pronto para inicializa√ß√£o', 'info');
        });
    </script>
</body>
</html>
